---
title: "Project Draft"
author: '%>% it Up!: Lilly Clark, Thea Dowrich and Daisy Fang'
date: "4/15/2020"
output: 
  html_document:
    keep_md: yes
    theme: spacelab
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(gifski)
library(gganimate)
library(maps)
library(usmap)
library(viridis)
library(patchwork)
library(sf)
library(plotly)
```

```{r load-data, results="hide"}
facilities <- read.csv("data/all_health_facilities.csv")
insurance <- read.csv("data/insurance.csv")
inpatients <- read.csv("data/medicare_inpatients.csv")
medicaid <- read_csv("data/Total Medicaid.csv")
states_pop <- read.csv("data/states_pop.csv")
facilities_ny <- read.csv("data/ny_specific/all_health_facilities_ny.csv")
inpatients_ny <- read.csv("data/ny_specific/medicare_inpatients_ny.csv")
medicare_ny <- read_csv("data/ny_specific/medicare_ny.csv")
ny_metro_map <- st_read("nyc_maps/ny_metro_map/ny_metro_map.shp", stringsAsFactors = FALSE)
```

## Introduction
***
The beginning of this new decade has been marked by significant uncertainty and difficulty. Coronavirus disease (COVID-19) originated in Wuhan, China in December 2019, but was not declared a Public Health Emergency of International Concern by the World Health Organization (WHO) until January 30. On March 11, WHO recognized the coronavirus as a pandemic  and on March 13, the United States declared a national emergency. 

After Donald Trump declared a national emergency, life as we knew it in America was largely disrupted: schools, colleges and universities closed, restaurants and bars prohibit dining in, and companies have shifted to remote work.  Stay-at-home and shelter-in-place orders have been in place across the nation, but individual responses per state have been largely variable. Responses by state are primarily dependent upon their healthcare system’s capacity. Testing has not been universally accessible and the number of necessary equipment (i.e., ventilators) is not up to standard, across the board.  

Coronavirus has been shown to impact marginalized communities at a more intense rate, but nobody is immune to the virus. Nationwide, access to specialized medical care is highly dependent upon one’s socioeconomic and employment status. Thus, we wanted to take a deeper look into these access disparities in the age of a global pandemic. Changes to healthcare policy, such as the Affordable Care Act of 2010 (ACA), have made inexpensive healthcare available to more constituents. However, there is still a long way to go, and the virus has brought many of these inequalities to light.

The following questions guided our research in investigating nationwide healthcare inequity: 

**1.	Are there disparities in healthcare access across the United States?**

**2.	As New York was one of the first hot spots for the virus, what inequalities to access exist within the New York Metropolitan Area?**

**3.	How do these differences in access relate to differences in patient experience?**

**4.	How have health policy changes influenced accessibility?**

## Disparities in Healthcare Access
***
From testing, contact tracing to treatment, access to hospitals is critically important in the context of a pandemic such as the coronavirus. According to the World Health Organization, patients with mild symptoms of COVID-19 should self-isolate and take measures such as resting, drinking sufficient fluid and eating nutritious food. However, for those with severe symptoms including fever, cough and difficulty breathing, patients should seek medical care at a hospital immediately. As the demand for care rises dramatically with the spread of the virus, it is more important now than ever to understand the capacity of the healthcare system across different states in the US.

### Hospital Beds Capacity

```{r us-hospitals, fig.align = "center"}
facilities <- left_join(facilities, states_pop, by = c("state" = "states_abb"))

# filter for hospitals in the contiguous US
hospitals <- facilities %>% 
  filter(overall_type == "hospital") %>% 
  #filter(long > -130 & long < -60) %>% 
  #filter(lat > 20 & lat < 50) %>% 
  mutate(owner = as.character(owner)) %>% 
  mutate(general_owner = case_when(owner %in% c("Government - District/Authority", "Government - Federal",
                                             "Government - Local", "Government - State") ~ "Government",
                                   owner == "Proprietary" ~ "For-Profit",
                                   TRUE ~ owner))

# map of hospitals
hospital_cnt <- hospitals %>% 
  group_by(state) %>% 
  summarize(total_hospitals = n(),
            total_beds = sum(beds, na.rm = TRUE))

hospital_cnt <- left_join(hospital_cnt, states_pop, by = c("state" = "states_abb"))

hospital_cnt <- hospital_cnt %>% 
  mutate(hospital_ratio = states_pop / total_hospitals,
         hospital_per_th = (total_hospitals / states_pop)*1000,
         bed_per_th = (total_beds / states_pop)*1000)

plot_usmap(data = hospital_cnt, values = 'bed_per_th') + 
  scale_fill_continuous(low = "white", high = "brown",
                        name = "# Beds per \n1k People", label = scales::comma) + 
  theme(legend.position = "right") +
  labs(title = "Population-Dense Area Along the Coasts Are Low in Hospital Beds Per 1k Population")
```

As illustrated in the map above, the number of hospital beds per 1000 people is highest in the West North Central region of the Midwest and the Mountain region of the West. This is unfortunate for the current situation because these are areas in the US with relatively low population density and less urgen concern of the coronavirus. On the other hand, densely populated areas along both coasts surrounding major cities have comparatively low hospital per capita. For example, Washington, California and New York have relatively lighter colors on the map which indicate a low hospital beds to population ratio. New York in particular has become a hot spot with leading counts of coronavirus cases, surpassing that of China combined. This visualization reveals that hospital over-capacity and lack of supplies is not surprising given the relative number of hospital beds adjusted by population is low in a state where risk of contact is high. 

### Hospital Owner Type

The number of hospitals is only a piece of the puzzle in understanding healthcare access. Hospital owner type also influences a patient's ability to receive care. While the federal government requires all hospitals to administer free stabilizing care to all patients who seek help, only non-profit hospitals are obligated to threat all conditions regardless of the patients' financial or health insurance status. They also generally charges a lower rate than for-profit hospitals. Government hospital are even less likely than non-profit hospitals to offer relatively unprofitable services.

<center>

```{r hospital-owner}
# proportion of owner type by state bar graph
hospital_owner <- hospitals %>% 
  filter(general_owner != "Not Available") %>% 
  filter(state %in% c("NY", "CA", "TX", "NC")) %>% 
  group_by(state, general_owner) %>% 
  summarise(n = n()) %>%
  mutate(Proportion = n / sum(n)) %>% 
  rename(Type = general_owner, State = state)

hospital_owner_viz <- hospital_owner %>% 
  ggplot(aes(x = State, y = Proportion, fill = Type)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = c("grey47", "goldenrod1", "darkorange3")) +
  theme_light() +
  labs(fill = "Owner type",
       title = "Proportion of Hospital Types Differ Largely by State")
ggplotly(hospital_owner_viz)
```

</center>

The bar graph above shows that the breakdown of hospital owner type varies dramatically across states. New York has almost exclusively non-profit and government hospitals, the highest proportion in the country, while Texas has less than half, the lowest proportion in the country. California and North Carolina fall in the middle, which serve as references to these two states. Because of the high proportion of non-profit and government hospitals, the healthcare system in New York is relatively more accessible especially to at-risk populations during this pandemic.

### Healthcare Facilities Finder
In the interest of consolidating information on healthcare facilities across the country, below is a ShinyApp that allows you to obtain information on all available facilities in a city that fit your needs. Please make sure to enter all State, County and City information! The application is also available at: https://daisyfang.shinyapps.io/facilities_finder/
</br>

<center>

```{r finder-app}
knitr::include_app("https://daisyfang.shinyapps.io/facilities_finder/", height = "500px")
```

</center>

## Disparities in the New York Metropolitan Area
***

Although a high proportion of non-profit and government hospitals makes the New York healthcare system more equipped to address the needs of at-risk populations during this crisis, hospitals in the New York City metropolitan area have also been some of the hardest hit. New York City is the epicenter of coronavirus cases in the US and has seen 12,199 of New York State's 14,636 COVID-19 deaths, roughly a third of all the US coronavirus deaths as of April 17. The New York Metropolitan area is facing unprecedented healthcare challenges and provides an excellent stage to examine disparities in health care access.

```{r eval=FALSE}
ggplot() +
  geom_sf(ny_metro_map, mapping = aes(geometry = geometry)) +
  geom_point(data = subset(facilities_ny, overall_type == "hospital"), 
             mapping = aes(x = long, y = lat, alpha = .3, color = "red")) +
  scale_color_manual(values = "red") +
  theme(legend.position = "none") +
  labs(title = "Location of Hospitals in New York City Metro Area")
```

```{r eval=FALSE}
cols <- c("Below the national average" = "red", "Above the national average" = "#0A97F0", "Same as the national average" = "black")
```

```{r eval=FALSE}
medicare_locations_plot <- medicare_ny %>%
  ggplot() +
  geom_sf(data = ny_metro_map, aes(geometry = geometry),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(aes(x = long, y = lat, color = "red"), alpha = .6) +
  scale_color_manual(values = "red", guide = FALSE) +
  coord_sf() +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Locations of Medicare Providers")
```

```{r eval=FALSE}
medicare_ratings_map1 <- medicare_ny %>%
    filter(!is.na(effectiveness_of_care_national_comparison))

effectiveness_plot <- medicare_ratings_map1 %>%
  ggplot() +
  geom_sf(data = ny_metro_map, aes(geometry = geometry),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(data = subset(medicare_ratings_map1, 
                           effectiveness_of_care_national_comparison == "Same as the national average"),
             aes(x = long, y = lat, color = effectiveness_of_care_national_comparison), 
             alpha = .4) +
  geom_point(data = subset(medicare_ratings_map1, 
                           effectiveness_of_care_national_comparison == "Above the national average"),
             aes(x = long, y = lat, color = effectiveness_of_care_national_comparison), 
             alpha = .4) +
  geom_point(data = subset(medicare_ratings_map1, 
                           effectiveness_of_care_national_comparison == "Below the national average"),
             aes(x = long, y = lat, color = effectiveness_of_care_national_comparison), 
             alpha = .4) +
  scale_color_manual(values = cols) +
  coord_sf() +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Effectiveness of Care for Medicare Providers",
       color = "Effectiveness of care")
```

```{r eval=FALSE}
medicare_ratings_map2 <- medicare_ny %>%
    filter(!is.na(timeliness_of_care_national_comparison))

timeliness_plot <- medicare_ratings_map2 %>%
  ggplot() +
  geom_sf(data = ny_metro_map, aes(geometry = geometry),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(data = subset(medicare_ratings_map2, 
                           timeliness_of_care_national_comparison == "Same as the national average"),
             aes(x = long, y = lat, color = timeliness_of_care_national_comparison), 
             alpha = .4) +
  geom_point(data = subset(medicare_ratings_map2, 
                           timeliness_of_care_national_comparison == "Above the national average"),
             aes(x = long, y = lat, color = timeliness_of_care_national_comparison), 
             alpha = .4) +
  geom_point(data = subset(medicare_ratings_map2, 
                           timeliness_of_care_national_comparison == "Below the national average"),
             aes(x = long, y = lat, color = timeliness_of_care_national_comparison), 
             alpha = .4) +
  scale_color_manual(values = cols) +
  coord_sf() +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Timeliness of Care for Medicare Providers",
       color = "Timeliness of care")
```

```{r eval=FALSE, fig.width = 8, fig.height = 12}
medicare_locations_plot / effectiveness_plot / timeliness_plot
```

Despite the availability of Medicare providers in the New York City Metro Area, effectiveness of care for many providers closer to the city itself is lacking. Timeliness of medicare providers throughout the metro area lags behind the national average, and as it becomes clear in a viral pandemic, access to timely health care is necessary to ensure the well-being of at-risk Americans.

## Changes in Healthcare Policy and Access
***
The previously mentioned policy changes are marked by the consistent goal to improve the health and well-being for all Americans. A particularly vulnerable population within the healthcare arena is low-income individuals, as shown in how many of these policies directly target this demographic. Therefore, it is important to look at how changes in Medicaid policy, as well as other healthcare reform legislation, have influenced coverage on the state-level. The following visualization depicts the relationship between Medicaid spending and enrollee population from 1991 to 2014. 

```{r medicaid-changes, cache=TRUE}
medicaid <- medicaid %>%
  rename(
    spending = `Spending (in Millions of Dollars)`,
    enrollment = `Medicaid Enrollee Population (Thousands)`
  )

medicaid$Year <- as.integer(medicaid$Year)

ggplot(data = medicaid, mapping = aes(x = spending, y = enrollment, colour = State)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap(~Region, ncol = 4) +
  theme_light(base_size = 11) +
  labs(title = "Increased Spending Correlates with Higher Medicaid Enrollment in \n States Across All Regions of the US", 
       subtitle = 'Year: {frame_time}', x = 'Spending (in Millions of Dollars)', y = 'Medicaid Enrollee Population (in Thousands)') +
  transition_time(Year) +
  ease_aes('linear')

```

```{r nyc-changes, fig.align = "center"}
total <- read_csv("data/TM with USA.csv")

ny <- medicaid %>%
  filter(State == "New York")

usa <- total %>%
  filter(State == "United States")

spending <- ggplot() +
  geom_line(data = ny, mapping = aes(x = Year, y = spending), color = "blue") +
  labs(title = "Changes in Medicaid Spending",
       subtitle = "for the state of New York from 1991 to 2014",
       x = "Year", y = "Spending (in Millions of Dollars)") +
  theme_light()

enrollment <- ggplot() +
  geom_line(data = ny, mapping = aes(x = Year, y = enrollment), color = "blue") +
  labs(title = "Changes in Medicaid Enrollee Population",
       subtitle = "for the state of New York from 1991 to 2014",
       x = "Year", y = "Enrollment (in Thousands)") +
  theme_light()

spending / enrollment
```

## References
https://www.who.int/news-room/q-a-detail/q-a-coronaviruses#   
https://www.worldometers.info/coronavirus/country/us/     
https://www.healthcare-management-degree.net/faq/are-non-profit-or-for-profit-hospitals-better/    
https://www.healthaffairs.org/doi/full/10.1377/hlthaff.24.3.790     
https://simplemaps.com/data/us-cities    

