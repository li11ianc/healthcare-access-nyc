---
title: "Project Draft"
author: '%>% it Up!: Lilly Clark, Thea Dowrich and Daisy Fang'
date: "4/15/2020"
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r packages}
library(tidyverse)
library(gifski)
library(gganimate)
library(maps)
library(usmap)
library(viridis)
library(patchwork)
```

```{r load-data}
facilities <- read.csv("data/all_health_facilities.csv")
insurance <- read.csv("data/insurance.csv")
inpatients <- read.csv("data/medicare_inpatients.csv")
medicaid <- read_csv("data/Total Medicaid.csv")
states_pop <- read.csv("data/states_pop.csv")
```

## Introduction
***
The beginning of this new decade has been marked by significant uncertainty and difficulty. Coronavirus disease (COVID-19) originated in Wuhan, China in December 2019, but was not declared a Public Health Emergency of International Concern by the World Health Organization (WHO) until January 30. On March 11, WHO recognized the coronavirus as a pandemic  and on March 13, the United States declared a national emergency. 

After Donald Trump declared a national emergency, life as we knew it in America was largely disrupted: schools, colleges and universities closed, restaurants and bars prohibit dining in, and companies have shifted to remote work.  Stay-at-home and shelter-in-place orders have been in place across the nation, but individual responses per state have been largely variable. Responses by state are primarily dependent upon their healthcare system’s capacity. Testing has not been universally accessible and the number of necessary equipment (i.e., ventilators) is not up to standard, across the board.  

Coronavirus has been shown to impact marginalized communities at a more intense rate, but nobody is immune to the virus. Nationwide, access to specialized medical care is highly dependent upon one’s socioeconomic and employment status. Thus, we wanted to take a deeper look into these access disparities in the age of a global pandemic. Changes to healthcare policy, such as the Affordable Care Act of 2010 (ACA), have made inexpensive healthcare available to more constituents.  However, there is still a long way to go, and the virus has brought many of these inequalities to light.

The following questions guided our research in investigating nationwide healthcare inequity: 

<br>
1.	Are there disparities in healthcare access across the United States?

<br>
2.	As New York was one of the first hot spots for the virus, what inequalities to access exist within the state?

<br>
3.	How do these differences in access relate to differences in patient experience?

<br>
4.	How have health policy changes influenced accessibility? 

## Disparities in Healthcare Access
***

```{r us-hospitals}
facilities <- left_join(facilities, states_pop, by = c("state" = "states_abb"))

# filter for hospitals in the contiguous US
hospitals <- facilities %>% 
  filter(overall_type == "hospital") %>% 
  #filter(long > -130 & long < -60) %>% 
  #filter(lat > 20 & lat < 50) %>% 
  mutate(owner = as.character(owner)) %>% 
  mutate(general_owner = case_when(owner %in% c("Government - District/Authority", "Government - Federal",
                                             "Government - Local", "Government - State") ~ "Government",
                                   owner == "Proprietary" ~ "For-Profit",
                                   TRUE ~ owner))

# map of hospitals
hospital_cnt <- hospitals %>% 
  group_by(state) %>% 
  summarize(total_hospitals = n(),
            total_beds = sum(beds, na.rm = TRUE))

hospital_cnt <- left_join(hospital_cnt, states_pop, by = c("state" = "states_abb"))

hospital_cnt <- hospital_cnt %>% 
  mutate(hospital_ratio = states_pop / total_hospitals,
         hospital_percap = total_hospitals / states_pop,
         bed_percap = total_beds / states_pop)

plot_usmap(data = hospital_cnt, values = 'total_hospitals') + 
  scale_fill_continuous(low = "white", high = "brown",
                        name = "# Hospitals", label = scales::comma) + theme(legend.position = "right")

plot_usmap(data = hospital_cnt, values = 'hospital_ratio') + 
  scale_fill_continuous(low = "white", high = "brown",
                        name = "Avg. # people served \nper hospital", label = scales::comma) + theme(legend.position = "right")

plot_usmap(data = hospital_cnt, values = 'hospital_percap') + 
  scale_fill_continuous(low = "white", high = "brown",
                        name = "# Hospital Per Capita", label = scales::comma) + theme(legend.position = "right")

plot_usmap(data = hospital_cnt, values = 'bed_percap') + 
  scale_fill_continuous(low = "white", high = "brown",
                        name = "# Beds Per Capita", label = scales::comma) + theme(legend.position = "right")
```

```{r hospital-owner}
# proportion of owner type by state bar graph
hospitals %>% 
  filter(general_owner != "Not Available") %>% 
  filter(state %in% c("NY", "CA", "TX", "NC")) %>% 
  ggplot(aes(x = state, fill = general_owner)) +
  geom_bar(position = "fill") +
  scale_fill_brewer(palette = "Set2") +
  theme_light() +
  labs(x = "State", y = "Proportion", fill = "Owner type",
       title = "Proportion of Hospital Owner Types Differ Largely by State")
```

## Changes in Healthcare Policy and Access
***

```{r medicaid-changes, cache=TRUE}
medicaid <- medicaid %>%
  rename(
    spending = `Spending (in Millions of Dollars)`,
    enrollment = `Medicaid Enrollee Population (Thousands)`
  )

medicaid$Year <- as.integer(medicaid$Year)

ggplot(data = medicaid, mapping = aes(x = spending, y = enrollment, colour = State)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  scale_y_log10() +
  facet_wrap(~Region, ncol = 4) +
  theme_light(base_size = 11) +
  labs(title = "Increased Spending Correlates with Higher Medicaid Enrollment in \n States Across All Regions of the US", 
       subtitle = 'Year: {frame_time}', x = 'Spending (in Millions of Dollars)', y = 'Medicaid Enrollee Population (in Thousands)') +
  transition_time(Year) +
  ease_aes('linear')

```



