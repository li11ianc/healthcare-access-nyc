---
title: "inpatients"
author: "Lillian Clark"
date: "4/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages}
library(tidyverse)
library(maps)
library(plotly)
library(viridis)
```

```{r load-data}
inpatients <- read_csv("data/medicare_inpatients.csv")
medicare <- read_csv("data/medicare.csv")
```

From data.cms.gov: The Inpatient Utilization and Payment Public Use File (Inpatient PUF) provides information on inpatient discharges for Medicare fee-for-service beneficiaries. The Inpatient PUF includes information on utilization, payment (total payment and Medicare payment), and hospital-specific charges for the more than 3,000 U.S. hospitals that receive Medicare Inpatient Prospective Payment System (IPPS) payments. The PUF is organized by hospital and Medicare Severity Diagnosis Related Group (MS-DRG) and covers Fiscal Year (FY) 2017. MS-DRGs included in the PUF represent more than 7 million discharges or 75 percent of total Medicare IPPS discharges.

```{r}
inpatients <- inpatients %>%
  mutate(state = as.factor(state),
         drg = as.factor(str_extract(drg_definition, "\\d{3}")),
         drg_definition = as.factor(str_remove(drg_definition, "\\d{3} - ")),
         average_outofpocket = average_total_payments - average_medicare_payments,
         city = as.factor(city))

inpatients %>%
  distinct(name)
```

```{r}
medi <- left_join(inpatients, medicare, by = "name")
medi_filt <- medi %>%
  filter(!is.na(id.y))
```

```{r}
cities <- medi_filt %>%
  group_by(city.x, ) %>%
  summarize(mean = mean(average_outofpocket)) %>%
  arrange(desc(mean))

cities_loc <- medi_filt %>%
  select(city.x, state.x, long, lat)

cities <- left_join(cities, cities_loc, by = "city.x") %>%
  mutate(mean = round(mean, 2))
```

```{r}
inpatients %>%
  group_by(drg_definition) %>%
  summarize(mean = mean(average_outofpocket)) %>%
  arrange(desc(mean))

inpatients %>%
  group_by(state) %>%
  summarize(mean = mean(average_outofpocket)) %>%
  arrange(desc(mean))

inpatients %>%
  group_by(city) %>%
  summarize(mean = mean(average_outofpocket)) %>%
  arrange(desc(mean))
```

```{r}
medicare_ratings <- medicare %>%
  mutate(
    effectiveness_of_care_national_comparison = case_when(
      effectiveness_of_care_national_comparison == "Not Available" ~ as.character(NA),
      TRUE ~ effectiveness_of_care_national_comparison),
    timeliness_of_care_national_comparison = case_when(
      timeliness_of_care_national_comparison == "Not Available" ~ as.character(NA),
      TRUE ~ timeliness_of_care_national_comparison),
    timeliness_of_care_national_comparison = as.factor(timeliness_of_care_national_comparison),
    effectiveness_of_care_national_comparison = as.factor(effectiveness_of_care_national_comparison),
    effectiveness_of_care_national_comparison = fct_relevel(effectiveness_of_care_national_comparison,
                                                            c("Below the national average", "Above the national average", "Same as the national average"))
  )
```

```{r}
us_map <- map_data("state")
```

```{r}
medicare %>%
  filter(state != "HI", state != "AK", long > -140, lat > 22) %>%
  ggplot() +
  geom_polygon(data = us_map, aes(x=long, y=lat, group=group),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(aes(x = long, y = lat), alpha = .2) +
  coord_map() +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Locations of Medicare Providers", subtitle = "in 2017", caption = "Medicare providers are spread thin in some Midwestern states.")
```

```{r}
above_effective <- medicare_ratings %>%
  filter(effectiveness_of_care_national_comparison == "Above the national average")
below_effective <- medicare_ratings %>%
  filter(effectiveness_of_care_national_comparison == "Below the national average")
same_effective <- medicare_ratings %>%
  filter(effectiveness_of_care_national_comparison == "Same as the national average")
above_timely <- medicare_ratings %>%
  filter(timeliness_of_care_national_comparison == "Above the national average")
below_timely <- medicare_ratings %>%
  filter(timeliness_of_care_national_comparison == "Below the national average")
same_timely <- medicare_ratings %>%
  filter(timeliness_of_care_national_comparison == "Same as the national average")
```

```{r}
medicare_ratings_map <- medicare_ratings %>%
    filter(state != "HI", state != "AK", long > -140, lat > 22,
         !is.na(effectiveness_of_care_national_comparison))

medicare_ratings_map %>%
  ggplot() +
  geom_polygon(data = us_map, aes(x=long, y=lat, group=group),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(data = subset(medicare_ratings_map, effectiveness_of_care_national_comparison == "Same as the national average"), aes(x = long, y = lat, color = effectiveness_of_care_national_comparison)) +
  geom_point(data = subset(medicare_ratings_map, effectiveness_of_care_national_comparison == "Above the national average"), aes(x = long, y = lat, color = effectiveness_of_care_national_comparison)) +
  geom_point(data = subset(medicare_ratings_map, effectiveness_of_care_national_comparison == "Below the national average"), aes(x = long, y = lat, color = effectiveness_of_care_national_comparison)) +
  coord_map() +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Locations of Medicare Providers", subtitle = "in 2017", caption = "Medicare providers are spread thin in some Midwestern states.")
```


medicare_ratings %>%
  filter(state != "HI", state != "AK", long > -140, lat > 22) %>%
  ggplot() +
  geom_polygon(data = us_map, aes(x=long, y=lat, group=group),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(same_effective, aes(x = long, y = lat, color = effectiveness_of_care_national_comparison)) +
  geom_point(above_effective, aes(x = long, y = lat, color = effectiveness_of_care_national_comparison)) +
  geom_point(below_effective, aes(x = long, y = lat, color = effectiveness_of_care_national_comparison)) +
  coord_map() +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Locations of Medicare Providers", subtitle = "in 2017", caption = "Medicare providers are spread thin in some Midwestern states.")



```{r}
cities %>%
  arrange(mean) %>%
  filter(state.x != "HI", state.x != "AK", long > -140) %>%
  ggplot() +
  geom_polygon(data = us_map, aes(x=long, y=lat, group=group),
                   color="#9EA5A9", fill = "#CED5DA") +
  geom_point(aes(x = long, y = lat, color = mean, size = mean), alpha = .2) +
  coord_map() +
  scale_size_continuous(range=c(.1,5), guide = FALSE) +
  scale_color_viridis(trans="log") +
  theme_void() +
  theme(plot.caption = element_text(hjust = .5)) +
  labs(title = "Costs Not Covered By Medicare for Inpatient Procedures", color = "Mean out-of-pocket costs ($)", subtitle = "in 2017", caption = "Average out of pocket costs for Medicare-covered procedures signicantly higher in some California and East Coast cities.")
```

```{r}
cities %>%
  filter(state.x != "HI", lat < 25)
```

